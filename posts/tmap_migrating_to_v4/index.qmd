---
title: "Migrating to Version 4 of the tmap R Package"
date: "01/04/2025"
abstract-title: "ABSTRACT"
abstract: "My favourite mapping package just released a major update! In this post I discuss the changes made as they relate to my work, and provide some tips and tricks I have learnt so far when migration from Version 3.0 to Version 4.0."
image: "image.png"
format: html
title-block-banner: true #This is our banner
include-after-body: "../../html/html_footer.html" #This is our footer
---

# Introduction

The tmap package is one of my all time favourite R packages, and this latest update only solidified this opinion. I highly recommend that you check out the main page [here](https://r-tmap.github.io/tmap/index.html), and take the time to read over some of the documents in each of the tabs.

As of 2025-01-27, tmap version 4.0 was released, and with it came some BIG changes. The authors have done a great job making sure that the update is backwards compatible with your current code, however moving forward it is very important to start doing things the "new" way. One of the most impactful in my opinion is changes to the syntax used with a lot of the core functions. This new syntax makes things easier to understand, cleaner, and provides greater flexibility  in the creation of your maps. New datasets have also been added for demonstration purposes as well as the ability to extent tmap (to do things like map very unique spatial data types, or creating map overlays in a 3D environment).

# How things Used to Look

:::{.callout-note}
For the purposes of this blog I will assume a basic understanding of the tmap package.
:::

Right, so in version 3.0, how did things look? Well, if I'm honest they looked a little messy. Unfortunately I can't provide the datasets I used in my day-to-day, but lets roughly recreate how my code would have looked using some example data.

```{r}

library(tmap)
library(dplyr)

data <- NLD_muni |> 
  filter(province == "Fryslan")#|> 
 # slice_head(n = 10)

tm_shape(data) +
  tm_polygons(col = "name", border.col = "black", alpha = 0.8, palette = "Pastel1", legend.show = T) +
  tm_text("name", shadow = T, auto.placement = T, size = 0.6) +
  tm_layout(legend.bg.color = "white", legend.frame = "black", asp = 1.1,
            legend.outside = TRUE, legend.outside.position = "top")


#map <- tm_shape(seagrass, is.master = T) +
#  tm_borders(alpha = 0) +
#  tm_shape(qld) +
#  tm_polygons(col = "grey80") +
#  tm_shape(dt_background) +
#  tm_polygons(col = "grey90", border.col = "black") +
#  tm_shape(dt_marine) +
#  tm_polygons(col = "Geographic Area: All", border.col = "black", alpha = 0.3, palette = "Pastel1", legend.show = T) +
#  water_map +
#  tm_shape(tsv) +
#  tm_symbols(size = 0.3, col = "white", border.col = "black", border.lwd = 1, shape = 23) +
#  tm_text("PlaceName", shadow = T, auto.placement = T, size = 0.6) +
#  tm_shape(seagrass) +
#  tm_polygons(col = "Meadow ID", palette = "Set3", border.col = "black", legend.show = F) +
#  tm_text("Meadow ID", shadow = T, auto.placement = T, size = 1.5) +
#  tm_layout(legend.bg.color = "white", legend.frame = "black", asp = 1.1,
#            legend.position = c("left", "bottom"))



```



Main points to hit

 - demonstrate I can do mapping
 - show some things i used to do
 - show how i have updated those things
 
 
 Here is an example of what i used to do:
 
```{r}
 
 #build on these two layers with customization

 
```

things i have noticed

 - is.master is now is.main. doesn't seem to be a note of that one
 - auto.placement is now under opt_tm_text(point.label = T)
 - shadow is now under opt_tm_text(shadow = T)
 - organisation is much cleaner now, all the fill.xyz can be put together and it is easy to spot which arguments relate to one another
 - setting colours and styles makes much more sense now. doing the cat vs cont, and setting the palette etc.
 - my preferred lay out has changed. I now like to list each argument under the next - helps with grouping but does make code have more lines
 
 
 rasters have also changed alot.
 
 before:
 
```{r}
 
map <- tm_shape(qld) +
        tm_polygons(col = "grey80", border.col = "black") +
        tm_shape(get(bas_map_type[j]), is.master = T) +
        tm_raster(legend.reverse = T, palette = pal_type[j], midpoint = mid_type[[j]], style = "fixed", breaks = get(break_type[j])) 

 
```
 
 
after:

```{r}


  tm_shape(qld) +
      tm_polygons(fill = "grey80", 
                  col = "black") +
      tm_shape(get(reg_map_type[j]), is.main = T) +
      tm_raster(col.scale = tm_scale_intervals(style = "fixed",
                                               breaks = get(break_type[j]),
                                               midpoint = mid_type[[j]],
                                               values = pal_type[j]),
                col.legend = tm_legend(reverse = T))

```
 

facet is much easier.

before:

```{r}

#using unique regions
for (i in n3_marine_names) {
  
  #filter all basins by region
  region_basins <- n3_marine_region |> filter(Region == i)
  
  #get the associated basins
  basins <- n3_basins |> filter(Region == i)
  
  #create counter for j loop
  count <- 0
  
  #using years vector created by data sourcing script
  for (j in time(n3_dhw_5y)){
    
    #track counter
    count <- count + 1
    
    #mask to the specific region and year
    single_year_region <- trim(mask(n3_dhw_5y[[time(n3_dhw_5y) == j]], vect(region_basins)))
  
    #for the first map make a legend
    if (count == 1){
      
      #plot
      map <- tm_shape(single_year_region) +
        tm_raster(palette = dhw_cols, breaks = c(1:6), labels = dhw_lab) +
        tm_shape(qld) +
        tm_polygons(col = "grey80", border.col = "black") +
        tm_shape(region_basins, is.master = T) +
        tm_borders(col = "black") +
        tm_shape(basins) +
        tm_polygons(col = "grey90", border.col = "black") +
        tm_layout(asp = 5, legend.show = F, main.title = year(time(single_year_region)), main.title.position = "centre")
      
      #save the map
      assign(glue("map{count}"), map)
      
      #make a legend map
      legend_map <- tm_shape(single_year_region) + 
        tm_raster(palette = dhw_cols, breaks = c(1:6), labels = dhw_lab, legend.reverse = T, 
                  title = "Coral bleaching likelihood \n and number of DHW's") +
        tm_layout(legend.only = T, legend.title.size = 3,
                  legend.text.size = 1.6, legend.position = c(0, 0.3))
      
    #otherwise, no legend
    } else {
        
      #plot
      map <- tm_shape(single_year_region) +
        tm_raster(palette = dhw_cols, breaks = c(1:6), labels = dhw_lab) +
        tm_shape(qld) +
        tm_polygons(col = "grey80", border.col = "black") +
        tm_shape(region_basins, is.master = T) +
        tm_borders(col = "black") +
        tm_shape(basins) +
        tm_polygons(col = "grey90", border.col = "black") +
        tm_layout(asp = 5, legend.show = F, main.title = year(time(single_year_region)), main.title.position = "centre")
      
      #save the map
      assign(glue("map{count}"), map)
        
    }
  }  
  
  #arrange into two rows
  facet_map <- tmap_arrange(map1, map2, map3, map4, map5, nrow = 2)
  
  #edit variable name for better save path
  i_lower <- tolower(gsub(" ", "-", i))
 
  #save the map as a png
  tmap_save(facet_map, filename = glue("{output_path}/plots/{i_lower}_dhw_fyear-{current_fyear}-to-{current_fyear-4}.png"))
  
  #save the legend seperately
  tmap_save(legend_map, glue("{output_path}/plots/{i_lower}_dhw_fyear-{current_fyear}-to-{current_fyear-4}_legend.png"))
  
}


```

after:


```{r}

#plot
  facet_map <- tm_shape(all_year_region) +
    tm_raster(col.scale = tm_scale_intervals(values = dhw_cols, 
                                             breaks = c(1:6),
                                             labels = dhw_lab),
              col.free = FALSE,
              col.legend = tm_legend(title = "Coral bleaching likelihood and number of DHW's")) +
    tm_shape(qld) +
    tm_polygons(fill = "grey80",
                col = "black") +
    tm_shape(region_basins, is.main = T) +
    tm_borders(col = "black") +
    tm_shape(basins) +
    tm_polygons(fill = "grey90", 
                col = "black") +
    tm_layout(panel.labels = year(time(n3_dhw_5y))) +
    tm_facets_hstack()


```















